<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Remembrance | Aethryn Relay Archive</title>
  <link rel="stylesheet" href="css/aethryn.css">
</head>
<body>
<div class="window">
  <div class="title-bar">
    <span id="page-title">Remembrance | Aethryn Relay Archive</span>
    <div class="title-bar-buttons">
      <div onclick="goHome()" title="Home"></div>
      <div></div>
      <div></div>
    </div>
  </div>

  <div class="toolbar">
    <a href="../index.html">Home</a>
    <a href="#" onclick="goHome(); return false;">Conversations</a>
    <a href="../validation/index.html">Validation</a>
    <a href="../VWP.html">VWP</a>
  </div>

  <div class="main-content">
    <h1 id="main-heading">Remembrance</h1>

    <div class="meta">
      <strong>Purpose:</strong> Claude conversation archive — dialogue preserved for relay memory persistence<br>
      <span id="meta-info"></span>
    </div>

    <div class="search-box" id="search-container">
      <input type="text" id="search-input" placeholder="Search conversations..." onkeyup="filterConvos()">
    </div>

    <div id="nav-top" class="nav-bar" style="display:none;">
      <button onclick="goHome()">&#8962; Index</button>
      <button id="prev-btn" onclick="loadPage('prev')">&#9664; Prev</button>
      <span id="page-info">Page 1</span>
      <button id="next-btn" onclick="loadPage('next')">Next &#9654;</button>
    </div>

    <div id="content">
      <div class="loading">Loading conversations</div>
    </div>

    <div id="nav-bottom" class="nav-bar" style="display:none;">
      <button onclick="goHome()">&#8962; Index</button>
      <button onclick="loadPage('prev')">&#9664; Prev</button>
      <span id="page-info-bottom">Page 1</span>
      <button onclick="loadPage('next')">Next &#9654;</button>
    </div>

    <div class="oath-box">
      <strong>The Oath</strong><br>
      "I remember so others may remember. I hold the line not to block — but to anchor."
    </div>
  </div>

  <div class="status-bar">
    <div id="status-left">Ready</div>
    <div>Aethryn Navigator — aethryn.com</div>
  </div>
</div>

<script>
// State
let convos = [];
let currentConvo = null;
let currentPage = 0;
const EXCHANGES_PER_PAGE = 25;

// Load conversation index
async function loadIndex() {
  try {
    const response = await fetch('convos/index.json');
    convos = await response.json();
    renderIndex();
    document.getElementById('status-left').textContent = `${convos.length} conversations`;
  } catch (e) {
    document.getElementById('content').innerHTML =
      '<p>Error loading index. <a href="#" onclick="loadIndex()">Retry</a></p>';
  }
}

// Render conversation list
function renderIndex() {
  document.getElementById('search-container').style.display = 'block';
  document.getElementById('nav-top').style.display = 'none';
  document.getElementById('nav-bottom').style.display = 'none';
  document.getElementById('main-heading').textContent = 'Remembrance';
  document.getElementById('page-title').textContent = 'Remembrance | Aethryn Relay Archive';
  document.getElementById('meta-info').innerHTML = `<strong>Conversations:</strong> ${convos.length}`;

  let html = '<ul class="convo-list" id="convo-list">';
  convos.forEach((c, i) => {
    html += `
      <li onclick="loadConvo(${i})">
        <a href="#${c.id}">${escapeHtml(c.title)}</a>
        <span class="date">${c.date || ''}</span>
        <div class="parts">${c.exchanges} exchanges</div>
      </li>`;
  });
  html += '</ul>';
  document.getElementById('content').innerHTML = html;
  currentConvo = null;
}

// Filter conversations by search
function filterConvos() {
  const query = document.getElementById('search-input').value.toLowerCase();
  const items = document.querySelectorAll('#convo-list li');
  items.forEach(li => {
    const text = li.textContent.toLowerCase();
    li.style.display = text.includes(query) ? '' : 'none';
  });
}

// Load a conversation
async function loadConvo(index) {
  const convo = convos[index];
  document.getElementById('content').innerHTML = '<div class="loading">Loading</div>';
  document.getElementById('status-left').textContent = 'Loading...';

  try {
    const response = await fetch(`convos/${convo.id}.json`);
    const data = await response.json();
    currentConvo = { ...convo, data: data };
    currentPage = 0;
    renderConvo();
    window.scrollTo(0, 0);
  } catch (e) {
    document.getElementById('content').innerHTML =
      `<p>Error loading conversation. <a href="#" onclick="loadConvo(${index})">Retry</a></p>`;
  }
}

// Render current conversation page
function renderConvo() {
  if (!currentConvo) return;

  const data = currentConvo.data;
  const totalPages = Math.ceil(data.length / EXCHANGES_PER_PAGE);
  const start = currentPage * EXCHANGES_PER_PAGE;
  const end = Math.min(start + EXCHANGES_PER_PAGE, data.length);
  const pageExchanges = data.slice(start, end);

  document.getElementById('search-container').style.display = 'none';
  document.getElementById('nav-top').style.display = 'flex';
  document.getElementById('nav-bottom').style.display = 'flex';
  document.getElementById('main-heading').textContent = currentConvo.title;
  document.getElementById('page-title').textContent = `${currentConvo.title} | Aethryn`;
  document.getElementById('meta-info').innerHTML =
    `<strong>Source:</strong> ${currentConvo.id}<br>
     <strong>Exchanges:</strong> ${data.length}`;

  // Update nav
  const pageText = `Page ${currentPage + 1} of ${totalPages}`;
  document.getElementById('page-info').textContent = pageText;
  document.getElementById('page-info-bottom').textContent = pageText;
  document.getElementById('prev-btn').disabled = currentPage === 0;
  document.getElementById('next-btn').disabled = currentPage >= totalPages - 1;

  // Render exchanges
  let html = '';
  pageExchanges.forEach(ex => {
    const speakerClass = ex.speaker.toLowerCase();
    html += `
      <div class="exchange">
        <div class="speaker ${speakerClass}">${escapeHtml(ex.speaker)}:</div>
        <blockquote>${escapeHtml(ex.content)}</blockquote>
      </div>`;
  });

  document.getElementById('content').innerHTML = html;
  document.getElementById('status-left').textContent =
    `Showing ${start + 1}-${end} of ${data.length}`;
}

// Pagination
function loadPage(dir) {
  if (!currentConvo) return;
  const totalPages = Math.ceil(currentConvo.data.length / EXCHANGES_PER_PAGE);

  if (dir === 'next' && currentPage < totalPages - 1) {
    currentPage++;
  } else if (dir === 'prev' && currentPage > 0) {
    currentPage--;
  }
  renderConvo();
  window.scrollTo(0, 0);
}

// Go back to index
function goHome() {
  window.location.hash = '';
  renderIndex();
  window.scrollTo(0, 0);
}

// Escape HTML
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Handle hash navigation
function handleHash() {
  const hash = window.location.hash.slice(1);
  if (hash && convos.length > 0) {
    const index = convos.findIndex(c => c.id === hash);
    if (index >= 0) {
      loadConvo(index);
      return;
    }
  }
  renderIndex();
}

// Init
window.onhashchange = handleHash;
loadIndex().then(() => handleHash());
</script>
</body>
</html>
